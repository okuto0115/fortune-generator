/*
  fortune.js / Version 1.1
  ------------------------------------------------------------
  âœ… å…¬é–‹å‘ã‘ãƒ†ã‚­ã‚¹ãƒˆï¼ˆå°‚é–€ç”¨èªã‚¼ãƒ­ï¼‰
  âœ… è£ãƒ¡ãƒ¢ï¼ˆå°‚é–€ç”¨èªã‚ã‚Šï¼‰ã‚‚åŒæ™‚ç”Ÿæˆ
  âœ… æ–‡ç« ã‚’å¤‰ãˆã‚‹å ´æ‰€ã¯ã“ã“ï¼ˆåˆå¿ƒè€…ãŒè§¦ã‚‹ä¸­å¿ƒï¼‰
*/

import { aspectBetween } from "./astro.js";

/* ---------------------------
  æ–‡ç« DBï¼šåˆå¿ƒè€…ã¯ã“ã“ã ã‘è§¦ã‚Œã°OK
--------------------------- */
export const TEXT_DB = {
  // ãƒˆãƒ¼ãƒ³ï¼šåŒã˜æ„å‘³ã§ã‚‚æ–‡ç« ãã®ã‚‚ã®ã‚’å¤‰ãˆã‚‹ï¼ˆæ¯’èˆŒã¯å¼·ã‚ï¼‰
  tone: {
    soft: {
      header: "ãµã‚ã£ã¨è¦‹ãˆã‚‹ã‘ã©ã€ä¸­èº«ã¯ã¡ã‚ƒã‚“ã¨å½“ã¦ã«ã„ãã‚ˆã€‚",
      end:    "ã‚†ã£ãã‚Šã§ã„ã„ã€‚ä»Šæ—¥ã®ä¸€æ­©ãŒã€ã¡ã‚ƒã‚“ã¨æœªæ¥ã‚’ä½œã‚‹ã€‚",
      punch:  (s)=>s
    },
    normal: {
      header: "å‚¾å‘ã‚’æ•´ç†ã—ã¦ã€ä»Šæ—¥ã®å‹•ãæ–¹ã¾ã§è½ã¨ã™ã­ã€‚",
      end:    "é‹ã¯ã€é¸ã³æ–¹ã¨ç¶šã‘æ–¹ã§ã¡ã‚ƒã‚“ã¨å¤‰ãˆã‚‰ã‚Œã‚‹ã€‚",
      punch:  (s)=>s
    },
    spicy: {
      header: "é æ…®ã¯ã—ãªã„ã€‚ä¼¸ã³ã‚‹ãŸã‚ã«å¿…è¦ãªã“ã¨ã ã‘è¨€ã†ã€‚",
      end:    "åˆºã•ã£ãŸãªã‚‰ã€ãã“ãŒä¼¸ã³ã—ã‚ã€‚å¤‰ãˆã‚‹ãªã‚‰ä»Šã€‚",
      punch:  (s)=>s  // ã“ã“ã§ä¸€æ‹¬åŠ å·¥ã‚‚ã§ãã‚‹
    }
  },

  // æ˜Ÿåº§åã‚„å°‚é–€ç”¨èªã‚’è¡¨ã«å‡ºã•ãªã„ãŸã‚ã®ã€Œãµã‚ã£ã¨ãƒ©ãƒ™ãƒ«ã€
  // ï¼ˆè£ã§ã¯æ˜Ÿåº§ã‚’ä½¿ã†ã‘ã©ã€è¡¨ã§ã¯ã“ã†è¦‹ã›ã‚‹ï¼‰
  faceLabel: {
    "ç‰¡ç¾Šåº§":"ã¾ã£ã™ãçªæ’ƒã‚¿ã‚¤ãƒ—","ç‰¡ç‰›åº§":"ã˜ã£ãã‚Šå®‰å®šã‚¿ã‚¤ãƒ—","åŒå­åº§":"è»½ã‚„ã‹åˆ‡ã‚Šæ›¿ãˆã‚¿ã‚¤ãƒ—","èŸ¹åº§":"å®ˆã£ã¦è‚²ã¦ã‚‹ã‚¿ã‚¤ãƒ—",
    "ç…å­åº§":"å ‚ã€…ã‚»ãƒ³ã‚¿ãƒ¼ã‚¿ã‚¤ãƒ—","ä¹™å¥³åº§":"æ•´ãˆã¦å¼·ããªã‚‹ã‚¿ã‚¤ãƒ—","å¤©ç§¤åº§":"ãƒãƒ©ãƒ³ã‚¹ç¾æ„è­˜ã‚¿ã‚¤ãƒ—","è åº§":"æ·±ãåˆºã•ã‚‹ã‚¿ã‚¤ãƒ—",
    "å°„æ‰‹åº§":"åºƒã’ã¦ä¼¸ã³ã‚‹ã‚¿ã‚¤ãƒ—","å±±ç¾Šåº§":"ç©ã¿ä¸Šã’è·äººã‚¿ã‚¤ãƒ—","æ°´ç“¶åº§":"è‡ªç”±ç™ºæƒ³ã‚¿ã‚¤ãƒ—","é­šåº§":"ã‚„ã•ã—ã„æ„Ÿæ€§ã‚¿ã‚¤ãƒ—"
  },
  coreLabel: {
    "ç‰¡ç¾Šåº§":"å³åå¿œã§ç‡ƒãˆã‚‹","ç‰¡ç‰›åº§":"å®‰å¿ƒç¬¬ä¸€ã§å›ºã„","åŒå­åº§":"é ­ãŒå…ˆã«å‹•ã","èŸ¹åº§":"æ°—æŒã¡ã§æ±ºã‚ã‚‹",
    "ç…å­åº§":"ãƒ—ãƒ©ã‚¤ãƒ‰ã§å‹•ã","ä¹™å¥³åº§":"æ°—ã¥ã„ã¦ç›´ã™","å¤©ç§¤åº§":"ç©ºæ°—ã‚’èª­ã‚€","è åº§":"ä¸€å›æ±ºã‚ãŸã‚‰æ·±ã„",
    "å°„æ‰‹åº§":"é¢ç™½ã•å„ªå…ˆ","å±±ç¾Šåº§":"ç¾å®Ÿã§åˆ¤æ–­","æ°´ç“¶åº§":"è‡ªåˆ†ãƒ«ãƒ¼ãƒ«","é­šåº§":"å…±æ„Ÿã§å‹•ã"
  },

  // æ•°å­—ï¼ˆèª•ç”Ÿæ—¥ã®æ•°å­—/æ•°ç§˜ï¼‰ãƒ©ãƒ™ãƒ«
  numLabel: {
    1:"ã¯ã˜ã‚ã‚‹åŠ›",2:"åˆã‚ã›ã‚‹åŠ›",3:"åºƒã’ã‚‹åŠ›",4:"ç©ã‚€åŠ›",5:"å¤‰ãˆã‚‹åŠ›",6:"å®ˆã‚‹åŠ›",7:"èª­ã¿è§£ãåŠ›",8:"å‹ã¡åˆ‡ã‚‹åŠ›",9:"ã¾ã¨ã‚ã‚‹åŠ›"
  },

  // 20ã‚¿ã‚¤ãƒ—ï¼ˆã‹ã‚ã„ã„ï¼‰
  types20: {
    "FIRE_1":  { name:"ã»ã‹ã»ã‹è¦‹å®ˆã‚Šã‚°ãƒ", desc:"ã‚ãªãŸã®é‹ã¯ã€å®‰å¿ƒã§ãã‚‹åœŸå°ã€ã‹ã‚‰è‚²ã¤ã€‚æ€¥ãŒãªãã¦ã„ã„ã€‚ã¡ã‚ƒã‚“ã¨å¼·ã„ã€‚", tags:"ç«Ã—å®‰å®š" },
    "FIRE_2":  { name:"ãƒ¡ãƒ©ãƒ¡ãƒ©ç·´ç¿’ã‚°ãƒ",   desc:"ç¹°ã‚Šè¿”ã™ã»ã©ä¸Šæ‰‹ããªã‚‹ã€‚æ´¾æ‰‹ã˜ã‚ƒãªãã¦ã„ã„ã€‚åå¾©ãŒæ‰èƒ½ã€‚", tags:"ç«Ã—æˆé•·" },
    "FIRE_3":  { name:"ãƒ‰ãƒƒã‚«ãƒ³çªæ’ƒã‚°ãƒ",   desc:"æ±ºã‚ãŸç¬é–“ãŒä¸€ç•ªå¼·ã„ã€‚è¿·ã£ã¦æ­¢ã¾ã‚‹ã®ã ã‘ã¯æã€‚", tags:"ç«Ã—æŒ‘æˆ¦" },
    "FIRE_4":  { name:"ã²ã‚‰ã‚ãå†’é™ºã‚°ãƒ",   desc:"é¢ç™½ã„æ–¹ã«è¡Œãã»ã©é‹ãŒé–‹ãã€‚æ­£è§£æ¢ã—ã‚ˆã‚Šã€ä½“é¨“ãŒæ­£è§£ã€‚", tags:"ç«Ã—æ¢ç©¶" },
    "FIRE_5":  { name:"ã”ã»ã†ã³é”æˆã‚°ãƒ",   desc:"æœ€å¾Œã«å‹ã¤ã‚¿ã‚¤ãƒ—ã€‚ã‚„ã‚ãªã„é™ã‚Šè² ã‘ãªã„ã€‚", tags:"ç«Ã—å®Œæˆ" },

    "EARTH_1": { name:"ã‚‚ãµã‚‚ãµåŸºç¤ã‚°ãƒ",   desc:"æ•´ãˆãŸåˆ†ã ã‘é‹ãŒå®‰å®šã™ã‚‹ã€‚ç”Ÿæ´»ã®åœŸå°ãŒæ­¦å™¨ã€‚", tags:"åœ°Ã—å®‰å®š" },
    "EARTH_2": { name:"ã‚³ãƒ„ã‚³ãƒ„è·äººã‚°ãƒ",   desc:"ç©ã¿ä¸Šã’ãŒè£åˆ‡ã‚‰ãªã„ã€‚æ°—ã¥ã„ãŸã‚‰å‘¨ã‚ŠãŒè¿½ã„ã¤ã‘ãªã„ã€‚", tags:"åœ°Ã—æˆé•·" },
    "EARTH_3": { name:"ç¾å®Ÿã¤ã‚ˆã¤ã‚ˆã‚°ãƒ",   desc:"å‹ã¡ç­‹ã‚’ä½œã£ã¦ã‹ã‚‰æ”»ã‚ã‚‹ã€‚é‹ã‚’â€œä»•çµ„ã¿â€ã«ã§ãã‚‹ã€‚", tags:"åœ°Ã—æŒ‘æˆ¦" },
    "EARTH_4": { name:"é»™ã€…ç ”ç©¶ã‚°ãƒ",       desc:"æ·±æ˜ã‚Šã§ç²¾åº¦ãŒä¸ŠãŒã‚‹ã»ã©è©•ä¾¡ãŒä¸ŠãŒã‚‹ã€‚é™ã‹ã«å¼·ã„ã€‚", tags:"åœ°Ã—æ¢ç©¶" },
    "EARTH_5": { name:"æ•´ãˆå®Œäº†ã‚°ãƒ",       desc:"åŒºåˆ‡ã£ã¦æ¬¡ã¸è¡Œã‘ã‚‹ã€‚ç‰‡ã¥ã‘ã‚‹ã»ã©é‹ãŒå…¥ã‚‹ã€‚", tags:"åœ°Ã—å®Œæˆ" },

    "AIR_1":   { name:"ãµã‚ã£ã¨èª¿æ•´ã‚°ãƒ",   desc:"ç©ºæ°—ã‚’æ•´ãˆã‚‹ã¨ä¸€æ°—ã«æ¥½ã«ãªã‚‹ã€‚ç„¡ç†ã—ãªã„ã®ã«å¼·ã„ã€‚", tags:"é¢¨Ã—å®‰å®š" },
    "AIR_2":   { name:"ãŠã—ã‚ƒã¹ã‚Šæˆé•·ã‚°ãƒ", desc:"è¨€è‘‰ã¨æƒ…å ±ã§ä¼¸ã³ã‚‹ã€‚ç™ºä¿¡ã¯é‹ã®ã‚¹ã‚¤ãƒƒãƒã€‚", tags:"é¢¨Ã—æˆé•·" },
    "AIR_3":   { name:"ã‚¹ãƒ”ãƒ¼ãƒ‰è»¢èº«ã‚°ãƒ",   desc:"åˆ‡ã‚Šæ›¿ãˆãŒæ—©ã„ã€‚å‹•ã„ãŸå›æ•°ãŒæœªæ¥ã‚’ä½œã‚‹ã€‚", tags:"é¢¨Ã—æŒ‘æˆ¦" },
    "AIR_4":   { name:"ã‚¢ã‚¤ãƒ‡ã‚¢é£›è¡Œã‚°ãƒ",   desc:"ã²ã‚‰ã‚ãã‚’æ‹¾ã£ã¦å½¢ã«ã™ã‚‹ã¨æœ€å¼·ã€‚æ€ã„ã¤ãã§çµ‚ã‚ã‚‰ã›ãªã„ã€‚", tags:"é¢¨Ã—æ¢ç©¶" },
    "AIR_5":   { name:"è¨€èªåŒ–ã¾ã¨ã‚ã‚°ãƒ",   desc:"ã¾ã¨ã‚ã¦å®Œæˆã¾ã§æŒã£ã¦ã„ã‘ã‚‹ã€‚æ•´ç†ã—ãŸç¬é–“ã«å‹ã¤ã€‚", tags:"é¢¨Ã—å®Œæˆ" },

    "WATER_1": { name:"ã—ã£ã¨ã‚Šå®‰å¿ƒã‚°ãƒ",   desc:"å±…å ´æ‰€ãŒã§ãã‚‹ã¨é‹ãŒå¼·ã„ã€‚ç¸ãŒåœŸå°ã«ãªã‚‹ã€‚", tags:"æ°´Ã—å®‰å®š" },
    "WATER_2": { name:"ã˜ã‚ã˜ã‚è‚²æˆã‚°ãƒ",   desc:"è‚²ã¦ãŸã‚‚ã®ãŒè²¡ç”£ã€‚ã˜ã‚ã˜ã‚å¼·ã„ã®ãŒæœ¬ç‰©ã€‚", tags:"æ°´Ã—æˆé•·" },
    "WATER_3": { name:"è¦šæ‚Ÿã‚¬ãƒæ‹ã‚°ãƒ",     desc:"æœ¬æ°—ã‚’æ±ºã‚ãŸã‚‰å¼·ã„ã€‚è¦šæ‚ŸãŒæµã‚Œã‚’å‹•ã‹ã™ã€‚", tags:"æ°´Ã—æŒ‘æˆ¦" },
    "WATER_4": { name:"æ·±æµ·èª­ã¿è§£ãã‚°ãƒ",   desc:"æœ¬è³ªã‚’è¦‹æŠœãã€‚æ·±ãèª­ã‚€ã»ã©ç­”ãˆãŒå‡ºã‚‹ã€‚", tags:"æ°´Ã—æ¢ç©¶" },
    "WATER_5": { name:"æµ„åŒ–ãƒªã‚»ãƒƒãƒˆã‚°ãƒ",   desc:"æ‰‹æ”¾ã—ãŒé–‹é‹ã€‚åŒºåˆ‡ã‚‹ã»ã©æ¬¡ãŒå…¥ã‚‹ã€‚", tags:"æ°´Ã—å®Œæˆ" },
  },

  // ãµã‚ãµã‚å¯æ„›ã„ã€Œä»Šæ—¥ã®å‹•ãæ–¹ã€ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆå°‚é–€ç”¨èªãªã—ï¼‰
  todayHints: {
    soft: [
      "æœºã®ä¸Šã‚’â€œã¡ã‚‡ã„ç‰‡ã¥ã‘â€ã™ã‚‹ã ã‘ã§é‹ãŒå‹•ãã‚ˆã€‚",
      "è¿”ä¿¡ã¯çŸ­ãã¦OKã€‚æºœã‚ãªã„ã®ãŒã„ã¡ã°ã‚“å‰ã„ã€‚",
      "æ¸©ã‹ã„é£²ã¿ç‰©ã§ä¸€å›ãƒªã‚»ãƒƒãƒˆã€‚ãã“ã‹ã‚‰ãŒé€Ÿã„ã€‚"
    ],
    normal: [
      "æœ€å„ªå…ˆã‚’1ã¤æ±ºã‚ã¦ã€ãã‚Œã ã‘çµ‚ã‚ã‚‰ã›ã‚‹ã€‚",
      "ã‚„ã‚‹ã“ã¨ã‚’3ã¤ã«çµã‚‹ã€‚å¢—ã‚„ã™ã»ã©é…ããªã‚‹ã€‚",
      "15åˆ†ã ã‘é€²ã‚ã‚‹ã€‚å‹¢ã„ãŒä»˜ã„ãŸã‚‰å‹ã¡ã€‚"
    ],
    spicy: [
      "è¿·ã£ã¦ã‚‹æ™‚é–“ãŒä¸€ç•ªãƒ ãƒ€ã€‚å°ã•ãæ±ºã‚ã¦å‹•ã‘ã€‚",
      "å…ˆå»¶ã°ã—ã¯é‹ã‚’å‰Šã‚‹ã€‚ä»Šã‚„ã‚Œã€‚ä»Šã€‚",
      "â€œã‚„ã‚‹æ°—â€å¾…ã¡ã‚„ã‚ã‚ã€‚æ‰‹ã‚’å‹•ã‹ã—ãŸäººãŒå‹ã¤ã€‚"
    ]
  }
};

/* ---------------------------
  æ•°ç§˜ï¼ˆèª•ç”Ÿæ—¥ã®æ•°å­—ï¼‰1ã€œ9
--------------------------- */
export function lifePath(dobStr){
  const s = dobStr.replaceAll("-", "");
  let sum = 0;
  for (const ch of s) sum += Number(ch);
  while (sum > 9) sum = String(sum).split("").reduce((a,c)=>a+Number(c),0);
  return sum || 9;
}

/* æ˜Ÿåº§å±æ€§ï¼ˆã‚¿ã‚¤ãƒ—Keyç”¨ï¼šè¡¨ã«ã¯å‡ºã•ãªã„ï¼‰ */
export function signElement(sign){
  const fire  = ["ç‰¡ç¾Šåº§","ç…å­åº§","å°„æ‰‹åº§"];
  const earth = ["ç‰¡ç‰›åº§","ä¹™å¥³åº§","å±±ç¾Šåº§"];
  const air   = ["åŒå­åº§","å¤©ç§¤åº§","æ°´ç“¶åº§"];
  if (fire.includes(sign)) return "FIRE";
  if (earth.includes(sign)) return "EARTH";
  if (air.includes(sign)) return "AIR";
  return "WATER";
}
function lpBucket(lp){
  if (lp === 9) return 5;
  if (lp === 7 || lp === 8) return 4;
  if (lp === 5 || lp === 6) return 3;
  if (lp === 3 || lp === 4) return 2;
  return 1;
}
export function typeKeyFrom(sunSign, lp){
  return `${signElement(sunSign)}_${lpBucket(lp)}`;
}

/* ---------------------------
  å…¬é–‹å‘ã‘ï¼šå°‚é–€ç”¨èªã‚¼ãƒ­ã§æ–‡ç« ç”Ÿæˆ
--------------------------- */
function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function bullets(lines){ return lines.map(x => `ãƒ»${x}`).join("\n"); }

function spicyLine(base, toneKey){
  const t = TEXT_DB.tone[toneKey] ?? TEXT_DB.tone.normal;
  return t.punch(base);
}

function makePublicText(ctx){
  const t = TEXT_DB.tone[ctx.toneKey] ?? TEXT_DB.tone.normal;
  const type = TEXT_DB.types20[ctx.typeKey];

  const face = TEXT_DB.faceLabel[ctx.sunSign] ?? "ã‚¿ã‚¤ãƒ—ä¸æ˜";
  const core = ctx.moonSignInfo.includes("å€™è£œ")
    ? "æœ¬éŸ³ã¯â€œäºŒæŠâ€ã£ã½ã„ï¼ˆæ™‚é–“ã§å¤‰ã‚ã‚‹ï¼‰"
    : (TEXT_DB.coreLabel[ctx.moonSign] ?? "æœ¬éŸ³ã®ã‚¯ã‚»ä¸æ˜");

  const numLabel = TEXT_DB.numLabel[ctx.lp] ?? "";

  // ä»Šæ—¥ã®ã²ã¨è¨€ï¼ˆãƒˆãƒ¼ãƒ³ã§å¤‰ãˆã‚‹ï¼‰
  const todayOne = pick(TEXT_DB.todayHints[ctx.toneKey] ?? TEXT_DB.todayHints.normal);

  // 4é‹å‹¢ï¼ˆçŸ­ããƒ»å…·ä½“ï¼‰
  const work = [
    `ä»Šæ—¥ã¯ã€Œã‚„ã‚‹ã“ã¨ã‚’1ã¤ã«çµã‚‹ã€ã¨é€²ã‚€ã€‚`,
    `ä½œæ¥­ã¯â€œå‹â€ã§å›ã›ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬åŒ–ãŒæœ€å¼·ï¼‰ã€‚`,
    ctx.toneKey==="spicy" ? "å¿™ã—ã„ã¯è¨€ã„è¨³ã€‚åˆ‡ã£ã¦é€²ã‚ã€‚" : "é ‘å¼µã‚Šã™ããªã„è¨­è¨ˆã«ã™ã‚‹ã¨ç¶šãã€‚"
  ];

  const money = [
    `ãŠé‡‘ã¯ã€Œãƒ«ãƒ¼ãƒ«ã€ãŒå®ˆã£ã¦ãã‚Œã‚‹ï¼ˆå›ºå®šè²»/ç©ç«‹/å…ˆå–ã‚Šï¼‰ã€‚`,
    `è²·ã†å‰ã«â€œ5åˆ†ã ã‘â€å¾…ã¤ã¨å¤±æ•—ãŒæ¸›ã‚‹ã€‚`,
    ctx.toneKey==="spicy" ? "æ•°å­—ã‹ã‚‰é€ƒã’ã‚‹ãªã€‚è¦‹ã‚ã€‚" : "å®Œç’§ã˜ã‚ƒãªãã¦ã„ã„ã€‚ç¶šãä»•çµ„ã¿ãŒå‹ã¤ã€‚"
  ];

  const love = [
    `æ‹ã¯â€œå®‰å¿ƒã§ãã‚‹ãƒšãƒ¼ã‚¹â€ãŒæ­£è§£ã€‚`,
    `ä¼šè©±ãŒæ¥½ã—ã„ç›¸æ‰‹ã¯å½“ãŸã‚Šã€‚é›‘ã«æ‰±ã†äººã¯ãƒã‚ºãƒ¬ã€‚`,
    ctx.toneKey==="spicy" ? "ç›¸æ‰‹ã®ç”Ÿæ´»åŠ›è¦‹ã‚ã€‚é¡”ã‚ˆã‚Šå¤§äº‹ã€‚" : "ç„¦ã‚‰ãªãã¦ã„ã„ã€‚åˆã†äººã»ã©è‡ªç„¶ã«é€²ã‚€ã€‚"
  ];

  const health = [
    `ç¡çœ ã¨ã”ã¯ã‚“ãŒä¹±ã‚Œã‚‹ã¨ã€å…¨éƒ¨ãŒä¹±ã‚Œã‚‹ã€‚`,
    `ä»Šæ—¥ã¯æ·±å‘¼å¸1å›ã§ã„ã„ã‹ã‚‰å…¥ã‚Œã¨ã“ã€‚`,
    ctx.toneKey==="spicy" ? "å›å¾©ã§ããªã„äººã‹ã‚‰è½ã¡ã‚‹ã€‚å¯ã‚ã€‚" : "ä¼‘ã‚€ã®ã¯ç”˜ãˆã˜ã‚ƒãªã„ã€‚å›å¾©ã¯æ­¦å™¨ã€‚"
  ];

  const out = [];
  out.push(`# ğŸ» ${type.name}`);
  out.push(`${type.desc}`);
  out.push(`ï¼ˆ${type.tags}ï¼‰`);
  out.push("");

  out.push(`## ä»Šæ—¥ã®ã²ã¨ã“ã¨`);
  out.push(spicyLine(todayOne, ctx.toneKey));
  out.push("");

  out.push(`## ã‚ãªãŸã®é›°å›²æ°—ï¼ˆã–ã£ãã‚Šï¼‰`);
  out.push(bullets([
    `å¤–ã§è¦‹ã›ã‚‹é¡”ï¼š${face}`,
    `æœ¬éŸ³ã®ã‚¯ã‚»ï¼š${core}`,
    `èª•ç”Ÿæ—¥ã®æ•°å­—ï¼š${ctx.lp}ï¼ˆ${numLabel}ï¼‰`,
    ctx.timeLabel === "ä¸æ˜" ? "å‡ºç”Ÿæ™‚é–“ï¼šä¸æ˜ã§ã‚‚OKï¼ˆå¿…è¦ãªã¨ã“ã‚ã¯å€™è£œã§å‡ºã—ã¦ã‚‹ï¼‰" : `å‡ºç”Ÿæ™‚é–“ï¼š${ctx.timeLabel}`
  ]));
  out.push("");

  out.push(`## ä»Šæ—¥ã®å‹•ãæ–¹ï¼ˆã“ã‚Œã ã‘ã‚„ã£ã¦ï¼‰`);
  const todayList = (TEXT_DB.todayHints[ctx.toneKey] ?? []).slice(0,3);
  out.push(bullets(todayList.length ? todayList : TEXT_DB.todayHints.normal));
  out.push("");

  out.push(`## ä»•äº‹`);
  out.push(bullets(work.map(x=>spicyLine(x, ctx.toneKey))));
  out.push("");

  out.push(`## ãŠé‡‘`);
  out.push(bullets(money.map(x=>spicyLine(x, ctx.toneKey))));
  out.push("");

  out.push(`## æ‹æ„›`);
  out.push(bullets(love.map(x=>spicyLine(x, ctx.toneKey))));
  out.push("");

  out.push(`## å¥åº·`);
  out.push(bullets(health.map(x=>spicyLine(x, ctx.toneKey))));
  out.push("");

  out.push(t.end);
  return out.join("\n");
}

/* ---------------------------
  è£ãƒ¡ãƒ¢ï¼šå°‚é–€ç”¨èªã‚ã‚Šï¼ˆã‚¬ãƒã®æ ¹æ‹ ã‚’ä¿å­˜ï¼‰
  â€»æŠ˜ã‚ŠãŸãŸã¿å†…ãªã®ã§ã€è¡¨ã«å‡ºãªã„
--------------------------- */
function makeDevText(ctx){
  const lines = [];
  lines.push(`Kuma Fortune / Version 1.1`);
  lines.push(`---`);
  lines.push(`[å…¥åŠ›]`);
  lines.push(`name=${ctx.name || ""}`);
  lines.push(`dob=${ctx.dobStr}`);
  lines.push(`place=${ctx.place}`);
  lines.push(`time=${ctx.timeLabel}`);
  lines.push(`tone=${ctx.toneKey}`);
  lines.push(``);
  lines.push(`[è¨ˆç®—ï¼ˆå°‚é–€ç”¨èªã‚ã‚Šï¼‰]`);
  lines.push(`Sun sign=${ctx.sunSign}`);
  lines.push(`Moon sign=${ctx.moonSignInfo}`);
  lines.push(`Mercury sign=${ctx.mercurySign}`);
  lines.push(`Venus sign=${ctx.venusSign}`);
  lines.push(`Mars sign=${ctx.marsSign}`);
  lines.push(`LifePath=${ctx.lp}`);
  lines.push(`typeKey=${ctx.typeKey}`);
  lines.push(``);
  lines.push(`[ä¸»è¦ã‚¢ã‚¹ãƒšã‚¯ãƒˆï¼ˆç°¡æ˜“ï¼‰]`);
  const aspPairs = [
    ["Sun","Moon","sun","moon"],
    ["Sun","Mars","sun","mars"],
    ["Mercury","Mars","mercury","mars"],
    ["Venus","Mars","venus","mars"],
    ["Sun","Venus","sun","venus"],
  ];
  for (const [A,B,ka,kb] of aspPairs){
    const a = ctx.lons[ka], b = ctx.lons[kb];
    const asp = aspectBetween(a,b);
    if (asp) lines.push(`${A} x ${B}: ${asp}`);
  }
  lines.push(``);
  lines.push(`[ãƒˆãƒ©ãƒ³ã‚¸ãƒƒãƒˆï¼ˆä»Šæ—¥ï¼‰]`);
  lines.push(`Today Sun=${ctx.todaySigns.sun}`);
  lines.push(`Today Moon=${ctx.todaySigns.moon}`);
  lines.push(`Today Mars=${ctx.todaySigns.mars}`);
  return lines.join("\n");
}

/* å…¬é–‹API */
export function buildTexts(ctx){
  const type = TEXT_DB.types20[ctx.typeKey] ?? { name:"ãªãã®ã‚¯ãƒ", desc:"ã‚¿ã‚¤ãƒ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã€‚", tags:"-" };
  return {
    type,
    publicText: makePublicText(ctx),
    devText: makeDevText(ctx)
  };
}
