/*
  fortune.js / Version 1.4
  ------------------------------------------------------------
  âœ… å£èª¿ï¼šspicyï¼ˆæ¯’èˆŒï¼‰ã‚’å¼·åŒ–ï¼ˆå¥³ã®å­ãŒåˆºã™æ„Ÿã˜ï¼‰
     - å‘½ä»¤å£èª¿ã€Œã‚„ã‚Œã€ã¯é¿ã‘ã‚‹ â†’ ã€Œã‚„ã£ã¦ã€ã€Œã€œã—ãªï¼Ÿã€ã€Œé€ƒã’ãªã„ã§ï¼Ÿã€
     - ãŸã ã—å·®åˆ¥ãƒ»è„…ã—ãƒ»ä¸‹å“ã¯å…¥ã‚Œãªã„ï¼ˆåˆºã™ã‘ã©å“ã¯ä¿ã¤ï¼‰
  âœ… ä»Šæ—¥ã®ã²ã¨ã“ã¨ï¼šæ ¹æ‹ ã§æ±ºå®šï¼ˆä»Šæ—¥ã®æœˆÃ—ã‚ãªãŸã®ã‚¿ã‚¤ãƒ—ï¼‰
*/

import { aspectBetween } from "./astro.js";

export const TEXT_DB = {
  tone: {
    soft: {
      header: "ã†ã‚“ã†ã‚“ã€ã¡ã‚ƒã‚“ã¨è¦‹ãŸã‚ˆã€‚å¤§ä¸ˆå¤«ã ã‚ˆã€‚ä»Šæ—¥ã¯ã­ã€ã‚ãªãŸãŒå®‰å¿ƒã§ãã‚‹å½¢ã«æ•´ãˆã¦ã‚ã’ã‚‹ã­ã€œã€‚",
      closer: "ã§ãã¦ã‚‹ã¨ã“ã‚ã€ã¡ã‚ƒã‚“ã¨ã‚ã‚‹ã‚ˆã€‚ã ã‹ã‚‰ç„¦ã‚‰ãªãã¦ã„ã„ã®ã€‚ä»Šæ—¥ã®åˆ†ã ã‘ã€ã„ã£ã—ã‚‡ã«é€²ã‚‚ï¼Ÿ",
    },
    normal: {
      header: "ã‚ˆã—ã€å‚¾å‘ã¾ã¨ã‚ã‚‹ã­ã€‚ä»Šæ—¥ã®å‹•ãæ–¹ã¾ã§ã€ã¡ã‚ƒã‚“ã¨è½ã¨ã—ã¦ã„ãã‚ˆã€‚",
      closer: "é‹ã£ã¦ã­ã€é¸ã³æ–¹ã¨ç¶šã‘æ–¹ã§ã¡ã‚ƒã‚“ã¨å¤‰ã‚ã‚‹ã€‚ã ã‹ã‚‰å¤§ä¸ˆå¤«ã€‚",
    },
    spicy: {
      header: "ã¯ã„ã€è¦‹ãŸã‚ˆã€‚ã§ã€ã©ã†ã™ã‚‹ã®ï¼Ÿã“ã®ã¾ã¾â€œã‚„ã‚ŠãŸã„æ°—æŒã¡ã ã‘â€ã§çµ‚ã‚ã‚‹ï¼Ÿ",
      closer: "ãµãµã€åˆºã•ã£ãŸï¼Ÿã§ã‚‚ã­ã€åˆºã•ã‚‹ã£ã¦ã“ã¨ã¯ä¼¸ã³ã—ã‚ãŒã‚ã‚‹ã£ã¦ã“ã¨ã ã‚ˆã€‚",
    }
  },

  faceLabel: {
    "ç‰¡ç¾Šåº§":"ã¾ã£ã™ãçªæ’ƒã‚¿ã‚¤ãƒ—","ç‰¡ç‰›åº§":"ã˜ã£ãã‚Šå®‰å®šã‚¿ã‚¤ãƒ—","åŒå­åº§":"è»½ã‚„ã‹åˆ‡ã‚Šæ›¿ãˆã‚¿ã‚¤ãƒ—","èŸ¹åº§":"å®ˆã£ã¦è‚²ã¦ã‚‹ã‚¿ã‚¤ãƒ—",
    "ç…å­åº§":"å ‚ã€…ã‚»ãƒ³ã‚¿ãƒ¼ã‚¿ã‚¤ãƒ—","ä¹™å¥³åº§":"æ•´ãˆã¦å¼·ããªã‚‹ã‚¿ã‚¤ãƒ—","å¤©ç§¤åº§":"ãƒãƒ©ãƒ³ã‚¹ç¾æ„è­˜ã‚¿ã‚¤ãƒ—","è åº§":"æ·±ãåˆºã•ã‚‹ã‚¿ã‚¤ãƒ—",
    "å°„æ‰‹åº§":"åºƒã’ã¦ä¼¸ã³ã‚‹ã‚¿ã‚¤ãƒ—","å±±ç¾Šåº§":"ç©ã¿ä¸Šã’è·äººã‚¿ã‚¤ãƒ—","æ°´ç“¶åº§":"è‡ªç”±ç™ºæƒ³ã‚¿ã‚¤ãƒ—","é­šåº§":"ã‚„ã•ã—ã„æ„Ÿæ€§ã‚¿ã‚¤ãƒ—"
  },
  coreLabel: {
    "ç‰¡ç¾Šåº§":"å³åå¿œã§ç‡ƒãˆã‚‹","ç‰¡ç‰›åº§":"å®‰å¿ƒç¬¬ä¸€ã§å›ºã„","åŒå­åº§":"é ­ãŒå…ˆã«å‹•ã","èŸ¹åº§":"æ°—æŒã¡ã§æ±ºã‚ã‚‹",
    "ç…å­åº§":"ãƒ—ãƒ©ã‚¤ãƒ‰ã§å‹•ã","ä¹™å¥³åº§":"æ°—ã¥ã„ã¦ç›´ã™","å¤©ç§¤åº§":"ç©ºæ°—ã‚’èª­ã‚€","è åº§":"ä¸€å›æ±ºã‚ãŸã‚‰æ·±ã„",
    "å°„æ‰‹åº§":"é¢ç™½ã•å„ªå…ˆ","å±±ç¾Šåº§":"ç¾å®Ÿã§åˆ¤æ–­","æ°´ç“¶åº§":"è‡ªåˆ†ãƒ«ãƒ¼ãƒ«","é­šåº§":"å…±æ„Ÿã§å‹•ã"
  },
  numLabel: {
    1:"ã¯ã˜ã‚ã‚‹åŠ›",2:"åˆã‚ã›ã‚‹åŠ›",3:"åºƒã’ã‚‹åŠ›",4:"ç©ã‚€åŠ›",5:"å¤‰ãˆã‚‹åŠ›",6:"å®ˆã‚‹åŠ›",7:"èª­ã¿è§£ãåŠ›",8:"å‹ã¡åˆ‡ã‚‹åŠ›",9:"ã¾ã¨ã‚ã‚‹åŠ›"
  },

  types20: {
    "FIRE_1":  { name:"ã»ã‹ã»ã‹è¦‹å®ˆã‚Šã‚°ãƒ", desc:"å®‰å¿ƒã§ãã‚‹åœŸå°ãŒã§ããŸç¬é–“ã€ã‚ãªãŸã®é‹ã¯ä¸€æ°—ã«ä¼¸ã³ã‚‹ã‚ˆã€‚", tags:"ç«Ã—å®‰å®š" },
    "FIRE_2":  { name:"ãƒ¡ãƒ©ãƒ¡ãƒ©ç·´ç¿’ã‚°ãƒ",   desc:"åå¾©ãŒæ‰èƒ½ã€‚åœ°å‘³ã«è¦‹ãˆã¦ã€ã„ã¡ã°ã‚“å¼·ã„è‚²ã¡æ–¹ã ã‚ˆã€‚", tags:"ç«Ã—æˆé•·" },
    "FIRE_3":  { name:"ãƒ‰ãƒƒã‚«ãƒ³çªæ’ƒã‚°ãƒ",   desc:"æ±ºã‚ã¦å‹•ã„ãŸç¬é–“ãŒæœ€å¼·ã€‚è¿·ã„ã§æ­¢ã¾ã‚‹ã®ã ã‘æã ã‚ˆã€‚", tags:"ç«Ã—æŒ‘æˆ¦" },
    "FIRE_4":  { name:"ã²ã‚‰ã‚ãå†’é™ºã‚°ãƒ",   desc:"é¢ç™½ã„æ–¹ã«è¡Œãã»ã©é‹ãŒé–‹ãã€‚ä½“é¨“ãŒæ­£è§£ã«ãªã‚‹ã‚¿ã‚¤ãƒ—ã ã‚ˆã€‚", tags:"ç«Ã—æ¢ç©¶" },
    "FIRE_5":  { name:"ã”ã»ã†ã³é”æˆã‚°ãƒ",   desc:"æœ€å¾Œã«å‹ã¤ã€‚ã‚„ã‚ãªã„é™ã‚Šè² ã‘ãªã„ã‚¿ã‚¤ãƒ—ã ã‚ˆã€‚", tags:"ç«Ã—å®Œæˆ" },

    "EARTH_1": { name:"ã‚‚ãµã‚‚ãµåŸºç¤ã‚°ãƒ",   desc:"æ•´ãˆãŸåˆ†ã ã‘å®‰å®šã™ã‚‹ã€‚ç”Ÿæ´»ã®åœŸå°ãŒãã®ã¾ã¾æ­¦å™¨ã ã‚ˆã€‚", tags:"åœ°Ã—å®‰å®š" },
    "EARTH_2": { name:"ã‚³ãƒ„ã‚³ãƒ„è·äººã‚°ãƒ",   desc:"ç©ã¿ä¸Šã’ãŒè£åˆ‡ã‚‰ãªã„ã€‚æ°—ã¥ã„ãŸã‚‰å‘¨ã‚ŠãŒè¿½ã„ã¤ã‘ãªã„ã‚ˆã€‚", tags:"åœ°Ã—æˆé•·" },
    "EARTH_3": { name:"ç¾å®Ÿã¤ã‚ˆã¤ã‚ˆã‚°ãƒ",   desc:"å‹ã¡ç­‹ã‚’ä½œã£ã¦ã‹ã‚‰æ”»ã‚ã‚‹ã€‚é‹ã‚’ä»•çµ„ã¿ã«ã§ãã‚‹ã‚ˆã€‚", tags:"åœ°Ã—æŒ‘æˆ¦" },
    "EARTH_4": { name:"é»™ã€…ç ”ç©¶ã‚°ãƒ",       desc:"æ·±æ˜ã‚Šã™ã‚‹ã»ã©è©•ä¾¡ãŒä¸ŠãŒã‚‹ã€‚é™ã‹ã«å¼·ã„ã®ãŒé­…åŠ›ã ã‚ˆã€‚", tags:"åœ°Ã—æ¢ç©¶" },
    "EARTH_5": { name:"æ•´ãˆå®Œäº†ã‚°ãƒ",       desc:"åŒºåˆ‡ã£ã¦æ¬¡ã¸è¡Œã‘ã‚‹ã€‚ç‰‡ã¥ã‘ã‚‹ã»ã©é‹ãŒå…¥ã£ã¦ãã‚‹ã‚ˆã€‚", tags:"åœ°Ã—å®Œæˆ" },

    "AIR_1":   { name:"ãµã‚ã£ã¨èª¿æ•´ã‚°ãƒ",   desc:"ç©ºæ°—ã‚’æ•´ãˆã‚‹ã¨ä¸€æ°—ã«ãƒ©ã‚¯ã«ãªã‚‹ã€‚ç„¡ç†ã—ãªã„ã®ã«å¼·ã„ã‚ˆã€‚", tags:"é¢¨Ã—å®‰å®š" },
    "AIR_2":   { name:"ãŠã—ã‚ƒã¹ã‚Šæˆé•·ã‚°ãƒ", desc:"è¨€è‘‰ã¨æƒ…å ±ã§ä¼¸ã³ã‚‹ã€‚ç™ºä¿¡ã¯é‹ã®ã‚¹ã‚¤ãƒƒãƒã ã‚ˆã€‚", tags:"é¢¨Ã—æˆé•·" },
    "AIR_3":   { name:"ã‚¹ãƒ”ãƒ¼ãƒ‰è»¢èº«ã‚°ãƒ",   desc:"åˆ‡ã‚Šæ›¿ãˆãŒæ—©ã„ã€‚å‹•ã„ãŸå›æ•°ãŒæœªæ¥ã‚’ä½œã‚‹ã‚ˆã€‚", tags:"é¢¨Ã—æŒ‘æˆ¦" },
    "AIR_4":   { name:"ã‚¢ã‚¤ãƒ‡ã‚¢é£›è¡Œã‚°ãƒ",   desc:"ã²ã‚‰ã‚ãã‚’æ‹¾ã£ã¦å½¢ã«ã§ããŸã‚‰æœ€å¼·ã€‚æ€ã„ã¤ãã§çµ‚ã‚ã‚‰ã›ãªã„ã§ã­ã€‚", tags:"é¢¨Ã—æ¢ç©¶" },
    "AIR_5":   { name:"è¨€èªåŒ–ã¾ã¨ã‚ã‚°ãƒ",   desc:"æ•´ç†ã—ãŸç¬é–“ã«å‹ã¤ã€‚è¨€è‘‰ã«ã§ããŸã‚‰ç¾å®ŸãŒã¤ã„ã¦ãã‚‹ã‚ˆã€‚", tags:"é¢¨Ã—å®Œæˆ" },

    "WATER_1": { name:"ã—ã£ã¨ã‚Šå®‰å¿ƒã‚°ãƒ",   desc:"å±…å ´æ‰€ãŒã§ãã‚‹ã¨é‹ãŒå¼·ã„ã€‚ç¸ãŒã‚ãªãŸã®åœŸå°ã«ãªã‚‹ã‚ˆã€‚", tags:"æ°´Ã—å®‰å®š" },
    "WATER_2": { name:"ã˜ã‚ã˜ã‚è‚²æˆã‚°ãƒ",   desc:"è‚²ã¦ãŸã‚‚ã®ãŒè²¡ç”£ã€‚ã˜ã‚ã˜ã‚å¼·ã„ã®ãŒæœ¬ç‰©ã ã‚ˆã€‚", tags:"æ°´Ã—æˆé•·" },
    "WATER_3": { name:"è¦šæ‚Ÿã‚¬ãƒæ‹ã‚°ãƒ",     desc:"æœ¬æ°—ã‚’æ±ºã‚ãŸã‚‰å¼·ã„ã€‚è¦šæ‚ŸãŒæµã‚Œã‚’å‹•ã‹ã™ã‚ˆã€‚", tags:"æ°´Ã—æŒ‘æˆ¦" },
    "WATER_4": { name:"æ·±æµ·èª­ã¿è§£ãã‚°ãƒ",   desc:"æœ¬è³ªã‚’è¦‹æŠœãã€‚æ·±ãèª­ã‚“ã åˆ†ã ã‘ç­”ãˆãŒå‡ºã‚‹ã‚ˆã€‚", tags:"æ°´Ã—æ¢ç©¶" },
    "WATER_5": { name:"æµ„åŒ–ãƒªã‚»ãƒƒãƒˆã‚°ãƒ",   desc:"æ‰‹æ”¾ã—ãŒé–‹é‹ã€‚åŒºåˆ‡ã‚‹ã»ã©ã€æ¬¡ãŒå…¥ã£ã¦ãã‚‹ã‚ˆã€‚", tags:"æ°´Ã—å®Œæˆ" },
  },
};

export function lifePath(dobStr){
  const s = dobStr.replaceAll("-", "");
  let sum = 0;
  for (const ch of s) sum += Number(ch);
  while (sum > 9) sum = String(sum).split("").reduce((a,c)=>a+Number(c),0);
  return sum || 9;
}

export function signElement(sign){
  const fire  = ["ç‰¡ç¾Šåº§","ç…å­åº§","å°„æ‰‹åº§"];
  const earth = ["ç‰¡ç‰›åº§","ä¹™å¥³åº§","å±±ç¾Šåº§"];
  const air   = ["åŒå­åº§","å¤©ç§¤åº§","æ°´ç“¶åº§"];
  if (fire.includes(sign)) return "FIRE";
  if (earth.includes(sign)) return "EARTH";
  if (air.includes(sign)) return "AIR";
  return "WATER";
}
function lpBucket(lp){
  if (lp === 9) return 5;
  if (lp === 7 || lp === 8) return 4;
  if (lp === 5 || lp === 6) return 3;
  if (lp === 3 || lp === 4) return 2;
  return 1;
}
export function typeKeyFrom(sunSign, lp){
  return `${signElement(sunSign)}_${lpBucket(lp)}`;
}

/* --- ä»Šæ—¥ã®ã²ã¨ã“ã¨ï¼ˆæ ¹æ‹ ã§æ±ºã‚ã‚‹ï¼‰ --- */
function hash01(str){
  let h = 2166136261;
  for (let i=0; i<str.length; i++){
    h ^= str.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return ((h >>> 0) % 10000) / 10000;
}
function pickDeterministic(list, seedStr){
  const x = hash01(seedStr);
  const idx = Math.floor(x * list.length);
  return list[Math.min(idx, list.length-1)];
}
function todayKeyFrom(ctx){
  const todayMood = signElement(ctx.todaySigns.moon);
  const yourBase  = ctx.typeKey.split("_")[0];
  const yourStep  = ctx.typeKey.split("_")[1];
  return `${todayMood}_${yourBase}_${yourStep}`;
}

function todayLinePool(toneKey, key){
  const [todayMood, yourBase] = key.split("_");
  const k2 = `${todayMood}_${yourBase}`;

  const soft = {
    "FIRE_FIRE": [
      "ä»Šæ—¥ã¯ã­ã€å‹¢ã„ãŒå‘³æ–¹ã ã‚ˆã€‚å°ã•ãã§ã„ã„ã‹ã‚‰ã€æœ€åˆã®ä¸€æ­©ã ã‘è¸ã¿å‡ºã—ã¦ã¿ã‚ˆï¼Ÿ",
      "ã‚„ã‚‹æ°—ã¯ã­ã€å‹•ã„ãŸã‚‰ã¤ã„ã¦ãã‚‹æ—¥ã ã‚ˆã€œã€‚ã ã‹ã‚‰ä¸€å›ã ã‘å§‹ã‚ã¦ã¿ã¦ã€‚",
      "è¿·ã†ãªã‚‰ã€ã„ã¡ã°ã‚“å°ã•ã„ã‚„ã¤ã‹ã‚‰ã§ã„ã„ã‚ˆã€‚ã¡ã‚ƒã‚“ã¨æ³¢ã«ä¹—ã‚Œã‚‹ã‚ˆã€‚"
    ],
    "EARTH_EARTH": [
      "ä»Šæ—¥ã¯â€œæ•´ãˆã‚‹ã ã‘ã§å‹ã¡â€ã®æ—¥ã ã‚ˆã€‚ã²ã¨ã¤æ•´ãˆãŸã‚‰å¿ƒãŒãµã‚ã£ã¨è»½ããªã‚‹ã‚ˆã€œã€‚",
      "å°ã•ãªç©ã¿ä¸Šã’ãŒã€ãã®ã¾ã¾æœªæ¥ã«ãªã‚‹æ—¥ã ã‚ˆã€‚ãˆã‚‰ã„ã‚ˆã€ã»ã‚“ã¨ã«ã€‚",
      "ä¸€å€‹ã ã‘æ•´ãˆã¦ã¿ã¦ã€‚ãã“ã‹ã‚‰å›ã‚Šå‡ºã™ã‚ˆã€‚"
    ],
  };

  // spicyï¼šã‚‚ã£ã¨åˆºã™ï¼ˆã§ã‚‚å‘½ä»¤å£èª¿ã€Œã‚„ã‚Œã€ã¯é¿ã‘ã‚‹ï¼‰
  const spicy = {
    "FIRE_FIRE": [
      "ä»Šæ—¥ã¯å‹¢ã„ã®æ—¥ã€‚è¿·ã£ã¦ã‚‹æ™‚é–“ã€ã‚‚ã£ãŸã„ãªã•ã™ãã‚‹ã‚ˆï¼Ÿå°ã•ãã§ã„ã„ã‹ã‚‰å§‹ã‚ã¦ã€‚",
      "ã‚„ã‚‹æ°—å¾…ã¡ã—ã¦ã‚‹ãªã‚‰ã€ãã®æ™‚ç‚¹ã§è² ã‘ã¦ã‚‹ã‚ˆã€‚å‹•ã„ã¦ã€ã¡ã‚ƒã‚“ã¨ã€‚",
      "æ±ºã‚ã¦ã€ã‚„ã£ã¦ã€‚ã‚ã¨ã§æ•´ãˆã‚Œã°ã„ã„ã®ã€‚"
    ],
    "FIRE_EARTH": [
      "é€²ã¾ãªã„ç†ç”±ã€ã ã„ãŸã„æ•£ã‚‰ã‹ã£ã¦ã‚‹ã ã‘ã ã‚ˆï¼Ÿå…ˆã«æ•´ãˆã¦ã€‚è¨€ã„è¨³ã„ã‚‰ãªã„ã€‚",
      "ã‚„ã‚‹ã“ã¨å¢—ã‚„ã—ã¦ãƒ‘ãƒ³ã‚¯ï¼Ÿãã‚Œã€è³¢ããªã„ã‚ˆã€‚æ¸›ã‚‰ã—ã¦ã‹ã‚‰å‹•ã„ã¦ã€‚",
      "ä¸€å€‹ã ã‘ç‰‡ã¥ã‘ã¦ã€‚æ¬²å¼µã‚‰ãªã„ã§ã€ã¾ãšãã‚Œã€‚"
    ],
    "EARTH_EARTH": [
      "ä»Šæ—¥ã¯ç©ã¿ä¸Šã’ã®æ—¥ã€‚ã“ã“ã§ã‚µãƒœã£ãŸã‚‰ã€ã‚ã¨ã§è‡ªåˆ†ãŒæ³£ãã‚ˆï¼Ÿã ã‹ã‚‰å°‘ã—ã ã‘ã§ã‚‚ã‚„ã£ã¦ã€‚",
      "â€œã„ã¤ã‹ã‚„ã‚‹â€ã£ã¦è¨€ã£ã¦ã‚‹ã†ã¡ã¯ä½•ã‚‚å¤‰ã‚ã‚‰ãªã„ã‚ˆã€‚ä»Šæ—¥ã¡ã‚‡ã£ã¨é€²ã‚ã¦ã€‚",
      "æ•´ãˆã‚‹ã ã‘ã§å‹ã¦ã‚‹æ—¥ãªã®ã«ã€ã‚„ã‚‰ãªã„ã®ã¯â€¦æ™®é€šã«ã‚‚ã£ãŸã„ãªã„ã‚ˆï¼Ÿ"
    ],
    "AIR_AIR": [
      "é ­ã®ä¸­ã§æ‚©ã‚“ã§ã‚‹æ™‚é–“ã€ã‚³ã‚¹ãƒ‘æ‚ªã„ã‚ˆï¼Ÿæ›¸ã„ã¦ã€‚è©±ã—ã¦ã€‚å‡ºã—ã¦ã€‚",
      "é€£çµ¡å¾Œå›ã—ã«ã—ã¦ã‚‹ãªã‚‰ã€ä»Šã®ã†ã¡ã«çŸ­ãè¿”ã—ã¦ã€‚æºœã‚ã‚‹ã»ã©ãƒ€ãƒ«ããªã‚‹ã ã‘ã€‚",
      "è¨€èªåŒ–ã—ã¦ã€‚ã¼ã‚“ã‚„ã‚Šã®ã¾ã¾ã«ã—ãªã„ã§ã€‚"
    ],
    "WATER_WATER": [
      "ä»Šæ—¥ã¯é ‘å¼µã‚‹æ—¥ã˜ã‚ƒãªã„ã€‚ç„¡ç†ã—ã¦å´©ã™ã®ã€ã„ã¡ã°ã‚“ãƒ€ã‚µã„ã‚ˆï¼Ÿä¼‘ã‚“ã§ã€‚",
      "æ„Ÿæƒ…ã§è‡ªåˆ†ã‚’é›‘ã«æ‰±ã‚ãªã„ã§ã€‚ãã“ã‹ã‚‰å…¨éƒ¨ä¹±ã‚Œã‚‹ã‚“ã ã‹ã‚‰ã€‚",
      "å›å¾©ã—ãªã„ã¨é€²ã¾ãªã„æ—¥ã€‚ã ã‹ã‚‰ã€ã¡ã‚ƒã‚“ã¨æˆ»ã—ã¦ã€‚"
    ],
  };

  if (toneKey === "soft") return soft[k2] ?? soft["EARTH_EARTH"];
  if (toneKey === "spicy") return spicy[k2] ?? spicy["EARTH_EARTH"];
  return (soft[k2] ?? soft["EARTH_EARTH"]).map(s => s.replaceAll("ã€œ", ""));
}

function makeTodayOneLine(ctx){
  const key = todayKeyFrom(ctx);
  const pool = todayLinePool(ctx.toneKey, key);
  const seed = `${ctx.dobStr}|${ctx.todayStr}|${ctx.typeKey}|${ctx.toneKey}`;
  return pickDeterministic(pool, seed);
}

/* --- å…¬é–‹æ–‡ç«  --- */
function makePublicText(ctx){
  const tonePack = TEXT_DB.tone[ctx.toneKey] ?? TEXT_DB.tone.normal;
  const type = TEXT_DB.types20[ctx.typeKey];
  const name = ctx.name?.trim() ? ctx.name.trim() : "ã‚ãªãŸ";

  const face = TEXT_DB.faceLabel[ctx.sunSign] ?? "ã‚¿ã‚¤ãƒ—ä¸æ˜";
  const core = ctx.moonSignInfo.includes("å€™è£œ")
    ? "æœ¬éŸ³ãŒäºŒæŠã£ã½ã„ï¼ˆå‡ºç”Ÿæ™‚é–“ã§ç¢ºå®šã™ã‚‹ã‚ˆï¼‰"
    : (TEXT_DB.coreLabel[ctx.moonSign] ?? "æœ¬éŸ³ã®ã‚¯ã‚»ä¸æ˜");
  const numLabel = TEXT_DB.numLabel[ctx.lp] ?? "";

  const todayOne = makeTodayOneLine(ctx);

  const lines = [];

  lines.push(`# ğŸ» ${type.name}`);
  lines.push(`${name}ã¯ã­ã€ã–ã£ãã‚Šè¨€ã†ã¨ã€Œ${type.desc}ã€ã£ã¦æ„Ÿã˜ã ã‚ˆã€‚`);
  lines.push("");

  lines.push(`## ä»Šæ—¥ã®ã²ã¨ã“ã¨`);
  lines.push(todayOne);
  lines.push("");

  lines.push(`## ${name}ã®é›°å›²æ°—`);
  lines.push(`å¤–ã§è¦‹ã›ã‚‹é¡”ã¯ã€Œ${face}ã€ã ã‚ˆã€‚å‘¨ã‚Šã‹ã‚‰ã¯ãã†è¦‹ã‚‰ã‚Œã‚„ã™ã„ã®ã€‚`);
  lines.push(`ã§ã‚‚æœ¬éŸ³ã®ã‚¯ã‚»ã¯ã€Œ${core}ã€ã€‚ã“ã“åˆ†ã‹ã£ã¦ã‚‹ã¨ã€ç„¡é§„ã«ç–²ã‚Œã«ãã„ã‚ˆã€‚`);
  lines.push(`ãã‚Œã¨ã€èª•ç”Ÿæ—¥ã®æ•°å­—ã¯ã€Œ${ctx.lp}ï¼ˆ${numLabel}ï¼‰ã€ã€‚ã‚ãªãŸã®ä¼¸ã³æ–¹ã®ã‚¯ã‚»ã€ã¿ãŸã„ãªã‚‚ã®ã ã‚ˆã€‚`);
  lines.push(ctx.timeLabel === "ä¸æ˜"
    ? `å‡ºç”Ÿæ™‚é–“ã¯ä¸æ˜ã§ã‚‚å¤§ä¸ˆå¤«ã ã‚ˆã€‚å¿…è¦ãªã¨ã“ã‚ã¯â€œå€™è£œâ€ã§ä¸å¯§ã«å‡ºã—ã¦ã‚‹ã‹ã‚‰ã­ã€‚`
    : `å‡ºç”Ÿæ™‚é–“ã¯ã€Œ${ctx.timeLabel}ã€ã§è¦‹ã¦ã‚‹ã‚ˆã€‚`
  );
  lines.push("");

  lines.push(`## ä»•äº‹`);
  if (ctx.toneKey === "soft"){
    lines.push(`ä»Šæ—¥ã¯ã€Œå°ã•ãå‡ºã—ã¦ã€ã‚ã¨ã§æ•´ãˆã‚‹ã€ãŒå‘ã„ã¦ã‚‹æ—¥ã ã‚ˆã€œã€‚ã§ãã‚‹å½¢ã§å‡ºã—ã¦ã¿ã‚ˆï¼Ÿ`);
  } else if (ctx.toneKey === "spicy"){
    lines.push(`å®Œç’§ã«ã—ã¦ã‹ã‚‰å‹•ãã®ã€é…ã„ã‚ˆï¼Ÿä»Šæ—¥ã¯â€œå°ã•ãå‡ºã—ã¦å›ã™â€ã§ã‚„ã£ã¦ã€‚é€ƒã’ãªã„ã§ã­ã€‚`);
  } else {
    lines.push(`ä»•äº‹ã¯ã€Œå°ã•ãå‡ºã—ã¦å›ã™ã€ãŒå¼·ã„æ—¥ã€‚ãƒ†ãƒ³ãƒ—ãƒ¬åŒ–ã‚‚åŠ¹ãã€‚`);
  }
  lines.push("");

  lines.push(`## ãŠé‡‘`);
  if (ctx.toneKey === "soft"){
    lines.push(`ä»Šæ—¥ã¯â€œãƒ«ãƒ¼ãƒ«ã‚’1å€‹ã ã‘â€ä½œã‚‹ã¨å®‰å¿ƒãŒå¢—ãˆã‚‹æ—¥ã ã‚ˆã€‚å°ã•ãã§ã„ã„ã‹ã‚‰ã­ã€œã€‚`);
  } else if (ctx.toneKey === "spicy"){
    lines.push(`æ•°å­—ã‹ã‚‰ç›®ãã‚‰ã—ã¦ã‚‹ãªã‚‰ã€ãã‚ãã‚ã‚„ã‚ã‚ˆï¼Ÿå›ºå®šè²»ã‹ãƒ«ãƒ¼ãƒ«ã€1å€‹ã ã‘æ•´ãˆã¦ã€‚ã¡ã‚ƒã‚“ã¨ã€‚`);
  } else {
    lines.push(`ãŠé‡‘ã¯ãƒ«ãƒ¼ãƒ«åŒ–ãŒæœ€å¼·ã€‚ä»Šæ—¥ã¯1ã¤ä»•çµ„ã¿ã‚’æ•´ãˆã‚‹ã¨å®‰å®šã™ã‚‹ã€‚`);
  }
  lines.push("");

  lines.push(`## æ‹æ„›`);
  if (ctx.toneKey === "soft"){
    lines.push(`ç„¦ã‚‰ãªãã¦ã„ã„ã‚ˆã€‚åˆã†äººã»ã©ä¼šè©±ãŒè‡ªç„¶ã«æ¥½ã—ã„ã‹ã‚‰ã­ã€œã€‚å®‰å¿ƒã§ãã‚‹ãƒšãƒ¼ã‚¹ã§ã„ã“ï¼Ÿ`);
  } else if (ctx.toneKey === "spicy"){
    lines.push(`é›‘ã«æ‰±ã†äººã«æ™‚é–“ã‚ã’ãªã„ã§ã€‚ã‚‚ã£ãŸã„ãªã„ã‹ã‚‰ã€‚è¨€è‘‰ã˜ã‚ƒãªãã¦è¡Œå‹•è¦‹ã¦ã­ï¼Ÿ`);
  } else {
    lines.push(`æ‹æ„›ã¯ã€Œä¼šè©±ã®æ°—æŒã¡ã‚ˆã•ã€ãŒéµã€‚ç„¡ç†ã—ãªã„ç›¸æ‰‹ãŒå½“ãŸã‚Šã€‚`);
  }
  lines.push("");

  lines.push(`## å¥åº·`);
  if (ctx.toneKey === "soft"){
    lines.push(`ä»Šæ—¥ã¯ç¡çœ ã¨å‘¼å¸ã‚’ã¡ã‚‡ã£ã¨ã ã‘æ„è­˜ã—ã¦ã­ã€‚ã‚ãªãŸã‚’å®ˆã‚‹åœŸå°ã ã‹ã‚‰ã€å¤§äº‹ã«ã—ã¦ã‚ã’ã‚ˆï¼Ÿ`);
  } else if (ctx.toneKey === "spicy"){
    lines.push(`å¯ãªã„ã§å´©ã‚Œã¦ã€Œæ™‚é–“ãªã„ã€ã£ã¦è¨€ã†ã®ã€ã»ã‚“ã¨ã«æã ã‚ˆï¼Ÿä»Šæ—¥ã¯å›å¾©ã«å¯„ã›ã¦ã€‚ã¡ã‚ƒã‚“ã¨å¯ã¦ã€‚`);
  } else {
    lines.push(`å¥åº·ã¯ç¡çœ ã¨é£Ÿäº‹ãŒãƒ™ãƒ¼ã‚¹ã€‚ä»Šæ—¥ã¯å›å¾©å¯„ã‚Šã«ã™ã‚‹ã¨å®‰å®šã€‚`);
  }
  lines.push("");

  lines.push(tonePack.header);
  lines.push(tonePack.closer);

  return lines.join("\n");
}

/* --- è£ãƒ¡ãƒ¢ --- */
function makeDevText(ctx){
  const lines = [];
  lines.push(`Kuma Fortune / Version 1.4`);
  lines.push(`---`);
  lines.push(`[å…¥åŠ›] name=${ctx.name || ""} dob=${ctx.dobStr} place=${ctx.place} time=${ctx.timeLabel} tone=${ctx.toneKey} today=${ctx.todayStr}`);
  lines.push(`[è¨ˆç®—] Sun=${ctx.sunSign} Moon=${ctx.moonSignInfo} Merc=${ctx.mercurySign} Ven=${ctx.venusSign} Mars=${ctx.marsSign} LP=${ctx.lp} typeKey=${ctx.typeKey}`);
  lines.push(`[ä¸»è¦ã‚¢ã‚¹ãƒšã‚¯ãƒˆï¼ˆç°¡æ˜“ï¼‰]`);
  const aspPairs = [
    ["Sun","Moon","sun","moon"],
    ["Sun","Mars","sun","mars"],
    ["Mercury","Mars","mercury","mars"],
    ["Venus","Mars","venus","mars"],
    ["Sun","Venus","sun","venus"],
  ];
  for (const [A,B,ka,kb] of aspPairs){
    const a = ctx.lons[ka], b = ctx.lons[kb];
    const asp = aspectBetween(a,b);
    if (asp) lines.push(`${A} x ${B}: ${asp}`);
  }
  lines.push(`[ä»Šæ—¥ã®ã²ã¨ã“ã¨ã‚­ãƒ¼] ${signElement(ctx.todaySigns.moon)}_${ctx.typeKey.split("_")[0]}_${ctx.typeKey.split("_")[1]}`);
  return lines.join("\n");
}

export function buildTexts(ctx){
  const type = TEXT_DB.types20[ctx.typeKey] ?? { name:"ãªãã®ã‚¯ãƒ", desc:"ã‚¿ã‚¤ãƒ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã€‚", tags:"-" };
  return {
    type,
    publicText: makePublicText(ctx),
    devText: makeDevText(ctx)
  };
}
