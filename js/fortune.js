/*
  fortune.js / Version 1.2
  ------------------------------------------------------------
  âœ… å…¬é–‹å‘ã‘ï¼šå°‚é–€ç”¨èªã‚¼ãƒ­ï¼ˆå®Œå…¨ã«â€œç¿»è¨³â€ï¼‰
  âœ… å£èª¿ï¼šå¥³ã®å­ã®è©±ã—è¨€è‘‰
     - softï¼šåŒ…ã¿è¾¼ã‚€ãƒ¬ãƒ™ãƒ«ã§å„ªã—ã„
     - normalï¼šãƒ•ãƒ©ãƒƒãƒˆã«å‹é”ã¸
     - spicyï¼šç½µå€’å¯„ã‚Šï¼ˆãŸã ã—ä¸‹å“/å·®åˆ¥èª/è„…ã—ã¯ç„¡ã—ï¼‰
  âœ… è£ãƒ¡ãƒ¢ï¼šå°‚é–€ç”¨èªã‚ã‚Šï¼ˆæŠ˜ã‚ŠãŸãŸã¿ç”¨ï¼‰
*/

import { aspectBetween } from "./astro.js";

export const TEXT_DB = {
  tone: {
    soft: {
      header: "ã†ã‚“ã€ã¡ã‚ƒã‚“ã¨è¦‹ãŸã‚ˆã€‚å¤§ä¸ˆå¤«ã€‚ä»Šã®ã‚ãªãŸã€ã¡ã‚ƒã‚“ã¨é€²ã‚ã‚‹ã‹ã‚‰ã­ã€‚",
      closer: "ç„¡ç†ã—ãªãã¦ã„ã„ã‚ˆã€‚ä»Šæ—¥ã§ãã‚‹åˆ†ã ã‘ã§ã€ååˆ†ãˆã‚‰ã„ã‹ã‚‰ã€‚",
      // èªå°¾ã‚„ç©ºæ°—æ„Ÿã‚’ã“ã“ã§èª¿æ•´ã§ãã‚‹
      say: (s)=>s
    },
    normal: {
      header: "ã‚ˆã—ã€å‚¾å‘ã¾ã¨ã‚ã‚‹ã­ã€‚ä»Šæ—¥ã©ã†å‹•ã‘ã°ãƒ©ã‚¯ã‹ã‚‚ä¸€ç·’ã«å‡ºã™ã‚ˆã€‚",
      closer: "é‹ã¯ã­ã€é¸ã³æ–¹ã¨ç¶šã‘æ–¹ã§ã¡ã‚ƒã‚“ã¨å¤‰ã‚ã‚‹ã€‚ã ã‹ã‚‰å¤§ä¸ˆå¤«ã€‚",
      say: (s)=>s
    },
    spicy: {
      header: "ã¯ã„è¦‹ãŸã€‚ç”˜ã‚„ã‹ã•ãªã„ã‚ˆã€‚ä¼¸ã³ãŸã„ãªã‚‰ç¾å®Ÿè¦‹ã‚ˆï¼Ÿ",
      closer: "åˆºã•ã£ãŸï¼Ÿãªã‚‰æ­£è§£ã€‚ãã“ç›´ã—ãŸã‚‰ã€ã‚ãªãŸå¼·ããªã‚‹ã‹ã‚‰ã€‚",
      // å¼·ã‚ã®ç½µå€’ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹ï¼ˆã§ã‚‚æš´è¨€ã®å“ã¯ä¿ã¤ï¼‰
      say: (s)=>s
    }
  },

  // è¡¨å‘ã‘ãƒ©ãƒ™ãƒ«ï¼ˆå°‚é–€ç”¨èªã‚’éš ã™ï¼‰
  faceLabel: {
    "ç‰¡ç¾Šåº§":"ã¾ã£ã™ãçªæ’ƒã‚¿ã‚¤ãƒ—","ç‰¡ç‰›åº§":"ã˜ã£ãã‚Šå®‰å®šã‚¿ã‚¤ãƒ—","åŒå­åº§":"è»½ã‚„ã‹åˆ‡ã‚Šæ›¿ãˆã‚¿ã‚¤ãƒ—","èŸ¹åº§":"å®ˆã£ã¦è‚²ã¦ã‚‹ã‚¿ã‚¤ãƒ—",
    "ç…å­åº§":"å ‚ã€…ã‚»ãƒ³ã‚¿ãƒ¼ã‚¿ã‚¤ãƒ—","ä¹™å¥³åº§":"æ•´ãˆã¦å¼·ããªã‚‹ã‚¿ã‚¤ãƒ—","å¤©ç§¤åº§":"ãƒãƒ©ãƒ³ã‚¹ç¾æ„è­˜ã‚¿ã‚¤ãƒ—","è åº§":"æ·±ãåˆºã•ã‚‹ã‚¿ã‚¤ãƒ—",
    "å°„æ‰‹åº§":"åºƒã’ã¦ä¼¸ã³ã‚‹ã‚¿ã‚¤ãƒ—","å±±ç¾Šåº§":"ç©ã¿ä¸Šã’è·äººã‚¿ã‚¤ãƒ—","æ°´ç“¶åº§":"è‡ªç”±ç™ºæƒ³ã‚¿ã‚¤ãƒ—","é­šåº§":"ã‚„ã•ã—ã„æ„Ÿæ€§ã‚¿ã‚¤ãƒ—"
  },
  coreLabel: {
    "ç‰¡ç¾Šåº§":"å³åå¿œã§ç‡ƒãˆã‚‹","ç‰¡ç‰›åº§":"å®‰å¿ƒç¬¬ä¸€ã§å›ºã„","åŒå­åº§":"é ­ãŒå…ˆã«å‹•ã","èŸ¹åº§":"æ°—æŒã¡ã§æ±ºã‚ã‚‹",
    "ç…å­åº§":"ãƒ—ãƒ©ã‚¤ãƒ‰ã§å‹•ã","ä¹™å¥³åº§":"æ°—ã¥ã„ã¦ç›´ã™","å¤©ç§¤åº§":"ç©ºæ°—ã‚’èª­ã‚€","è åº§":"ä¸€å›æ±ºã‚ãŸã‚‰æ·±ã„",
    "å°„æ‰‹åº§":"é¢ç™½ã•å„ªå…ˆ","å±±ç¾Šåº§":"ç¾å®Ÿã§åˆ¤æ–­","æ°´ç“¶åº§":"è‡ªåˆ†ãƒ«ãƒ¼ãƒ«","é­šåº§":"å…±æ„Ÿã§å‹•ã"
  },
  numLabel: {
    1:"ã¯ã˜ã‚ã‚‹åŠ›",2:"åˆã‚ã›ã‚‹åŠ›",3:"åºƒã’ã‚‹åŠ›",4:"ç©ã‚€åŠ›",5:"å¤‰ãˆã‚‹åŠ›",6:"å®ˆã‚‹åŠ›",7:"èª­ã¿è§£ãåŠ›",8:"å‹ã¡åˆ‡ã‚‹åŠ›",9:"ã¾ã¨ã‚ã‚‹åŠ›"
  },

  // 20ã‚¿ã‚¤ãƒ—ï¼ˆã‹ã‚ã„ã•ç¶­æŒï¼‰
  types20: {
    "FIRE_1":  { name:"ã»ã‹ã»ã‹è¦‹å®ˆã‚Šã‚°ãƒ", desc:"å®‰å¿ƒã§ãã‚‹åœŸå°ãŒã§ããŸç¬é–“ã€ã‚ãªãŸã®é‹ã¯ä¸€æ°—ã«ä¼¸ã³ã‚‹ã‚ˆã€‚", tags:"ç«Ã—å®‰å®š" },
    "FIRE_2":  { name:"ãƒ¡ãƒ©ãƒ¡ãƒ©ç·´ç¿’ã‚°ãƒ",   desc:"åå¾©ãŒæ‰èƒ½ã€‚åœ°å‘³ã«è¦‹ãˆã¦ã€ã„ã¡ã°ã‚“å¼·ã„è‚²ã¡æ–¹ã€‚", tags:"ç«Ã—æˆé•·" },
    "FIRE_3":  { name:"ãƒ‰ãƒƒã‚«ãƒ³çªæ’ƒã‚°ãƒ",   desc:"æ±ºã‚ã¦å‹•ã„ãŸç¬é–“ãŒæœ€å¼·ã€‚è¿·ã„ã§æ­¢ã¾ã‚‹ã®ã ã‘æã€‚", tags:"ç«Ã—æŒ‘æˆ¦" },
    "FIRE_4":  { name:"ã²ã‚‰ã‚ãå†’é™ºã‚°ãƒ",   desc:"é¢ç™½ã„æ–¹ã«è¡Œãã»ã©é‹ãŒé–‹ãã€‚ä½“é¨“ãŒæ­£è§£ã«ãªã‚‹ã‚¿ã‚¤ãƒ—ã€‚", tags:"ç«Ã—æ¢ç©¶" },
    "FIRE_5":  { name:"ã”ã»ã†ã³é”æˆã‚°ãƒ",   desc:"æœ€å¾Œã«å‹ã¤ã€‚ã‚„ã‚ãªã„é™ã‚Šè² ã‘ãªã„ã‚¿ã‚¤ãƒ—ã ã‚ˆã€‚", tags:"ç«Ã—å®Œæˆ" },

    "EARTH_1": { name:"ã‚‚ãµã‚‚ãµåŸºç¤ã‚°ãƒ",   desc:"æ•´ãˆãŸåˆ†ã ã‘å®‰å®šã™ã‚‹ã€‚ç”Ÿæ´»ã®åœŸå°ãŒãã®ã¾ã¾æ­¦å™¨ã€‚", tags:"åœ°Ã—å®‰å®š" },
    "EARTH_2": { name:"ã‚³ãƒ„ã‚³ãƒ„è·äººã‚°ãƒ",   desc:"ç©ã¿ä¸Šã’ãŒè£åˆ‡ã‚‰ãªã„ã€‚æ°—ã¥ã„ãŸã‚‰å‘¨ã‚ŠãŒè¿½ã„ã¤ã‘ãªã„ã€‚", tags:"åœ°Ã—æˆé•·" },
    "EARTH_3": { name:"ç¾å®Ÿã¤ã‚ˆã¤ã‚ˆã‚°ãƒ",   desc:"å‹ã¡ç­‹ã‚’ä½œã£ã¦ã‹ã‚‰æ”»ã‚ã‚‹ã€‚é‹ã‚’ä»•çµ„ã¿ã«ã§ãã‚‹ã€‚", tags:"åœ°Ã—æŒ‘æˆ¦" },
    "EARTH_4": { name:"é»™ã€…ç ”ç©¶ã‚°ãƒ",       desc:"æ·±æ˜ã‚Šã™ã‚‹ã»ã©è©•ä¾¡ãŒä¸ŠãŒã‚‹ã€‚é™ã‹ã«å¼·ã„ã®ãŒé­…åŠ›ã€‚", tags:"åœ°Ã—æ¢ç©¶" },
    "EARTH_5": { name:"æ•´ãˆå®Œäº†ã‚°ãƒ",       desc:"åŒºåˆ‡ã£ã¦æ¬¡ã¸è¡Œã‘ã‚‹ã€‚ç‰‡ã¥ã‘ã‚‹ã»ã©é‹ãŒå…¥ã£ã¦ãã‚‹ã€‚", tags:"åœ°Ã—å®Œæˆ" },

    "AIR_1":   { name:"ãµã‚ã£ã¨èª¿æ•´ã‚°ãƒ",   desc:"ç©ºæ°—ã‚’æ•´ãˆã‚‹ã¨ä¸€æ°—ã«ãƒ©ã‚¯ã«ãªã‚‹ã€‚ç„¡ç†ã—ãªã„ã®ã«å¼·ã„ã€‚", tags:"é¢¨Ã—å®‰å®š" },
    "AIR_2":   { name:"ãŠã—ã‚ƒã¹ã‚Šæˆé•·ã‚°ãƒ", desc:"è¨€è‘‰ã¨æƒ…å ±ã§ä¼¸ã³ã‚‹ã€‚ç™ºä¿¡ã¯é‹ã®ã‚¹ã‚¤ãƒƒãƒã€‚", tags:"é¢¨Ã—æˆé•·" },
    "AIR_3":   { name:"ã‚¹ãƒ”ãƒ¼ãƒ‰è»¢èº«ã‚°ãƒ",   desc:"åˆ‡ã‚Šæ›¿ãˆãŒæ—©ã„ã€‚å‹•ã„ãŸå›æ•°ãŒæœªæ¥ã‚’ä½œã‚‹ã€‚", tags:"é¢¨Ã—æŒ‘æˆ¦" },
    "AIR_4":   { name:"ã‚¢ã‚¤ãƒ‡ã‚¢é£›è¡Œã‚°ãƒ",   desc:"ã²ã‚‰ã‚ãã‚’æ‹¾ã£ã¦å½¢ã«ã§ããŸã‚‰æœ€å¼·ã€‚æ€ã„ã¤ãã§çµ‚ã‚ã‚‰ã›ãªã„ã§ã€‚", tags:"é¢¨Ã—æ¢ç©¶" },
    "AIR_5":   { name:"è¨€èªåŒ–ã¾ã¨ã‚ã‚°ãƒ",   desc:"æ•´ç†ã—ãŸç¬é–“ã«å‹ã¤ã€‚è¨€è‘‰ã«ã§ããŸã‚‰ç¾å®ŸãŒã¤ã„ã¦ãã‚‹ã€‚", tags:"é¢¨Ã—å®Œæˆ" },

    "WATER_1": { name:"ã—ã£ã¨ã‚Šå®‰å¿ƒã‚°ãƒ",   desc:"å±…å ´æ‰€ãŒã§ãã‚‹ã¨é‹ãŒå¼·ã„ã€‚ç¸ãŒã‚ãªãŸã®åœŸå°ã«ãªã‚‹ã€‚", tags:"æ°´Ã—å®‰å®š" },
    "WATER_2": { name:"ã˜ã‚ã˜ã‚è‚²æˆã‚°ãƒ",   desc:"è‚²ã¦ãŸã‚‚ã®ãŒè²¡ç”£ã€‚ã˜ã‚ã˜ã‚å¼·ã„ã®ãŒæœ¬ç‰©ã€‚", tags:"æ°´Ã—æˆé•·" },
    "WATER_3": { name:"è¦šæ‚Ÿã‚¬ãƒæ‹ã‚°ãƒ",     desc:"æœ¬æ°—ã‚’æ±ºã‚ãŸã‚‰å¼·ã„ã€‚è¦šæ‚ŸãŒæµã‚Œã‚’å‹•ã‹ã™ã€‚", tags:"æ°´Ã—æŒ‘æˆ¦" },
    "WATER_4": { name:"æ·±æµ·èª­ã¿è§£ãã‚°ãƒ",   desc:"æœ¬è³ªã‚’è¦‹æŠœãã€‚æ·±ãèª­ã‚“ã åˆ†ã ã‘ç­”ãˆãŒå‡ºã‚‹ã€‚", tags:"æ°´Ã—æ¢ç©¶" },
    "WATER_5": { name:"æµ„åŒ–ãƒªã‚»ãƒƒãƒˆã‚°ãƒ",   desc:"æ‰‹æ”¾ã—ãŒé–‹é‹ã€‚åŒºåˆ‡ã‚‹ã»ã©ã€æ¬¡ãŒå…¥ã£ã¦ãã‚‹ã€‚", tags:"æ°´Ã—å®Œæˆ" },
  }
};

/* æ•°ç§˜ */
export function lifePath(dobStr){
  const s = dobStr.replaceAll("-", "");
  let sum = 0;
  for (const ch of s) sum += Number(ch);
  while (sum > 9) sum = String(sum).split("").reduce((a,c)=>a+Number(c),0);
  return sum || 9;
}

/* æ˜Ÿåº§â†’ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆï¼ˆå†…éƒ¨ç”¨ï¼‰ */
export function signElement(sign){
  const fire  = ["ç‰¡ç¾Šåº§","ç…å­åº§","å°„æ‰‹åº§"];
  const earth = ["ç‰¡ç‰›åº§","ä¹™å¥³åº§","å±±ç¾Šåº§"];
  const air   = ["åŒå­åº§","å¤©ç§¤åº§","æ°´ç“¶åº§"];
  if (fire.includes(sign)) return "FIRE";
  if (earth.includes(sign)) return "EARTH";
  if (air.includes(sign)) return "AIR";
  return "WATER";
}
function lpBucket(lp){
  if (lp === 9) return 5;
  if (lp === 7 || lp === 8) return 4;
  if (lp === 5 || lp === 6) return 3;
  if (lp === 3 || lp === 4) return 2;
  return 1;
}
export function typeKeyFrom(sunSign, lp){
  return `${signElement(sunSign)}_${lpBucket(lp)}`;
}

/* å£èª¿ç”Ÿæˆï¼šãƒˆãƒ¼ãƒ³ã§è¨€ã„å›ã—ã‚’å¤‰ãˆã‚‹ */
function speak(toneKey, kind, normalLine){
  // kind: "soft"|"spicy" ã®å ´åˆã®å¤‰æ›ã«ä½¿ã†ï¼ˆå¿…è¦ãªã‚‰å¢—ã‚„ã›ã‚‹ï¼‰
  if (toneKey === "soft"){
    const map = {
      "move1":"ä»Šæ—¥ã¯ã­ã€ã²ã¨ã¤ã ã‘ã§ã„ã„ã‹ã‚‰çµ‚ã‚ã‚‰ã›ã‚ˆã€‚ã§ããŸã‚‰ãã‚Œã§å‹ã¡ã€‚",
      "move2":"è¿”ä¿¡ã¨ã‹å°ã•ã„ã‚¿ã‚¹ã‚¯ã€æºœã‚ã‚‹ã¨å¿ƒãŒé‡ããªã‚‹ã‹ã‚‰ã€è»½ãç‰‡ã¥ã‘ã‚ˆï¼Ÿ",
      "move3":"æ¸©ã‹ã„é£²ã¿ç‰©ã§ä¸€å›ãµã‚ã£ã¨æˆ»ã—ã¦ã€‚ãã“ã‹ã‚‰ãŒæ—©ã„ã‚ˆã€‚",
      "warn":"ç„¡ç†ã—ã¦é ‘å¼µã‚Šã™ããªã„ã§ã­ã€‚ã‚ãªãŸã®ãƒšãƒ¼ã‚¹ã§å¤§ä¸ˆå¤«ã€‚"
    };
    return map[kind] ?? normalLine;
  }
  if (toneKey === "spicy"){
    const map = {
      "move1":"å„ªå…ˆ1ã¤æ±ºã‚ã‚ã€‚å…¨éƒ¨ã‚„ã‚ã†ã¨ã™ã‚‹ãªã€‚å…¨éƒ¨ä¸­é€”åŠç«¯ã«ãªã‚‹ã€‚",
      "move2":"å…ˆå»¶ã°ã—ã¯æ‰èƒ½ã˜ã‚ƒãªã„ã€‚ãŸã ã®æã€‚ä»Šã‚„ã‚Œã€‚",
      "move3":"ã‚„ã‚‹æ°—å¾…ã¤ãªã€‚æ‰‹ã‚’å‹•ã‹ã—ãŸäººãŒå‹ã¤ã€‚ã¯ã„ã€å‹•ã‘ã€‚",
      "warn":"è¨€ã„è¨³ã—ã¦ã‚‹æš‡ã‚ã‚‹ãªã‚‰ã€1åˆ†ã§ã„ã„ã‹ã‚‰é€²ã‚ã‚ã€‚"
    };
    return map[kind] ?? normalLine;
  }
  return normalLine; // normal
}

/* å…¬é–‹æ–‡ç« ï¼ˆå°‚é–€ç”¨èªã‚¼ãƒ­ãƒ»ä¼šè©±èª¿ï¼‰ */
function makePublicText(ctx){
  const t = TEXT_DB.tone[ctx.toneKey] ?? TEXT_DB.tone.normal;
  const type = TEXT_DB.types20[ctx.typeKey];

  const face = TEXT_DB.faceLabel[ctx.sunSign] ?? "ã‚¿ã‚¤ãƒ—ä¸æ˜";
  const core = ctx.moonSignInfo.includes("å€™è£œ")
    ? "æœ¬éŸ³ãŒäºŒæŠã£ã½ã„ï¼ˆå‡ºç”Ÿæ™‚é–“ã§ç¢ºå®šã™ã‚‹ã‚ˆï¼‰"
    : (TEXT_DB.coreLabel[ctx.moonSign] ?? "æœ¬éŸ³ã®ã‚¯ã‚»ä¸æ˜");

  const numLabel = TEXT_DB.numLabel[ctx.lp] ?? "";

  const name = ctx.name?.trim() ? ctx.name.trim() : "ã‚ãªãŸ";

  // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã”ã¨ã«â€œã¤ãªãŒã‚‹æ–‡ç« â€ã«ã™ã‚‹
  const lines = [];

  lines.push(`# ğŸ» ${type.name}`);
  lines.push(`${name}ã¯ã­ã€ã–ã£ãã‚Šè¨€ã†ã¨ã€Œ${type.desc}ã€ã£ã¦æ„Ÿã˜ã€‚`);
  lines.push(`ã¡ã‚‡ã£ã¨å¯æ„›ãè¨€ã£ã¦ã‚‹ã‘ã©ã€ã“ã‚Œã‘ã£ã“ã†æ ¸å¿ƒã¤ã„ã¦ã‚‹ã‚ˆã€‚`);
  lines.push("");

  lines.push(`## ã¾ãšçµè«–ï¼ˆä»Šæ—¥ã®å‹•ãæ–¹ï¼‰`);
  lines.push(`${speak(ctx.toneKey, "move1", "ä»Šæ—¥ã¯æœ€å„ªå…ˆã‚’1ã¤ã«çµã‚‹ã¨ã€ã¡ã‚ƒã‚“ã¨é€²ã‚€ã‚ˆã€‚")}`);
  lines.push(`${speak(ctx.toneKey, "move2", "å°ã•ã„ã‚¿ã‚¹ã‚¯ã‚’å…ˆã«ç‰‡ã¥ã‘ã‚‹ã¨ã€æµã‚ŒãŒè»½ããªã‚‹ã€‚")}`);
  lines.push(`${speak(ctx.toneKey, "move3", "ä¸€å›ãƒªã‚»ãƒƒãƒˆã—ã¦ã‹ã‚‰å§‹ã‚ã‚‹ã¨é€Ÿã„ã€‚")}`);
  lines.push("");

  lines.push(`## ${name}ã®â€œè¦‹ãˆæ–¹â€ã¨â€œæœ¬éŸ³â€`);
  lines.push(`å¤–ã§è¦‹ã›ã‚‹é¡”ã¯ã€Œ${face}ã€ã€‚ã ã‹ã‚‰ã€å‘¨ã‚Šã«ã¯ãã†è¦‹ã‚‰ã‚Œã‚„ã™ã„ã€‚`);
  lines.push(`ã§ã‚‚æœ¬éŸ³ã®ã‚¯ã‚»ã¯ã€Œ${core}ã€ã€‚ã“ã“åˆ†ã‹ã£ã¦ã‚‹ã¨ã€ç„¡é§„ã«ç–²ã‚Œã«ãã„ã‚ˆã€‚`);
  lines.push(`ã‚ã¨èª•ç”Ÿæ—¥ã®æ•°å­—ã¯ã€Œ${ctx.lp}ï¼ˆ${numLabel}ï¼‰ã€ã€‚ã“ã‚Œã¯ã€ã‚ãªãŸã®â€œä¼¸ã³æ–¹ã®ç™–â€ã¿ãŸã„ãªã‚‚ã®ã€‚`);
  if (ctx.timeLabel === "ä¸æ˜"){
    lines.push(`å‡ºç”Ÿæ™‚é–“ã¯ä¸æ˜ã§ã‚‚å¤§ä¸ˆå¤«ã€‚å¿…è¦ãªã¨ã“ã‚ã¯â€œå€™è£œâ€ã§ä¸å¯§ã«å‡ºã—ã¦ã‚‹ã‚ˆã€‚`);
  } else {
    lines.push(`å‡ºç”Ÿæ™‚é–“ã¯ã€Œ${ctx.timeLabel}ã€ã§è¦‹ã¦ã‚‹ã‚ˆã€‚`);
  }
  lines.push("");

  lines.push(`## ä»•äº‹`);
  if (ctx.toneKey === "spicy"){
    lines.push(`ä»•äº‹ã­ã€‚ã¾ãšè¨€ã†ã‘ã©ã€å¿™ã—ã„ã¯å…ç½ªç¬¦ã˜ã‚ƒãªã„ã€‚åˆ‡ã£ã¦é€²ã‚ã€‚`);
    lines.push(`ä»Šæ—¥ã¯ã€Œãƒ†ãƒ³ãƒ—ãƒ¬åŒ–ã€ã¨ã€Œæœ€å°ã§å‡ºã™ã€ãŒå‹ã¡ç­‹ã€‚å®Œç’§ä¸»ç¾©ã‚„ã£ã¦ã‚‹ã¨é…ã„ã€‚`);
  } else if (ctx.toneKey === "soft"){
    lines.push(`ä»•äº‹ã¯ã­ã€é ‘å¼µã‚Šæ–¹ã‚’é–“é•ãˆãªã‘ã‚Œã°ã¡ã‚ƒã‚“ã¨ä¼¸ã³ã‚‹ã‚ˆã€‚`);
    lines.push(`ä»Šæ—¥ã¯ã€Œå‹ã«ã™ã‚‹ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ã«ã™ã‚‹ï¼‰ã€ã®ãŒåŠ©ã‘ã«ãªã‚‹ã€‚å°ã•ãå‡ºã—ã¦ã€è‚²ã¦ã‚ˆï¼Ÿ`);
  } else {
    lines.push(`ä»•äº‹ã¯ã€Œå‹ã€ã¨ã€Œå„ªå…ˆé †ä½ã€ã§é€²ã¿ã‚„ã™ã„æ—¥ã€‚`);
    lines.push(`ä»Šæ—¥ã¯å°ã•ãå‡ºã—ã¦å›ã™ã€ãŒã„ã¡ã°ã‚“å¼·ã„ã€‚`);
  }
  lines.push("");

  lines.push(`## ãŠé‡‘`);
  if (ctx.toneKey === "spicy"){
    lines.push(`ãŠé‡‘ã¯ã­ã€æ„Ÿæƒ…ã§è§¦ã‚‹ã¨è² ã‘ã‚‹ã€‚æ•°å­—ã‹ã‚‰é€ƒã’ã‚‹ãªã€‚`);
    lines.push(`ä»Šæ—¥ã¯å›ºå®šè²»ã¨â€œãƒ«ãƒ¼ãƒ«â€ã‚’1å€‹ã ã‘æ•´ãˆã‚ã€‚ãã‚Œã ã‘ã§å¾ŒãŒãƒ©ã‚¯ã€‚`);
  } else if (ctx.toneKey === "soft"){
    lines.push(`ãŠé‡‘ã£ã¦ä¸å®‰ã«ãªã‚Šã‚„ã™ã„ã‚ˆã­ã€‚ã§ã‚‚å¤§ä¸ˆå¤«ã€ä»•çµ„ã¿ã«ã™ã‚‹ã¨è½ã¡ç€ãã‚ˆã€‚`);
    lines.push(`ä»Šæ—¥ã¯ã€Œè²·ã†å‰ã«ã¡ã‚‡ã£ã¨å¾…ã¤ã€ã¨ã‹ã€å°ã•ã„ãƒ«ãƒ¼ãƒ«ãŒåŠ¹ãæ—¥ã€‚`);
  } else {
    lines.push(`ãŠé‡‘ã¯ã€Œãƒ«ãƒ¼ãƒ«åŒ–ã€ãŒæœ€å¼·ã€‚ä»Šæ—¥ã¯1ã¤ã ã‘ä»•çµ„ã¿ã‚’æ•´ãˆã‚‹ã¨å®‰å®šã™ã‚‹ã€‚`);
  }
  lines.push("");

  lines.push(`## æ‹æ„›`);
  if (ctx.toneKey === "spicy"){
    lines.push(`æ‹æ„›ã€‚è¨€ã£ã¨ãã‘ã©ã€â€œé›‘ã«æ‰±ã†äººâ€ã¯ã‚ãªãŸã®æ™‚é–“ã‚’å¥ªã†ã ã‘ã€‚åˆ‡ã‚Œã€‚`);
    lines.push(`ç›¸æ‰‹ã®å„ªã—ã•ã˜ã‚ƒãªãã¦ã€ç”Ÿæ´»ã®ä¸å¯§ã•ã‚’è¦‹ãªã€‚ãã“ã«äººé–“æ€§å‡ºã‚‹ã€‚`);
  } else if (ctx.toneKey === "soft"){
    lines.push(`æ‹æ„›ã¯ã­ã€ç„¦ã‚‰ãªãã¦ã„ã„ã€‚ã¡ã‚ƒã‚“ã¨åˆã†äººã£ã¦ã€è‡ªç„¶ã«ä¼šè©±ãŒæ¥½ã—ã„ã€‚`);
    lines.push(`ä»Šæ—¥ã¯â€œå®‰å¿ƒã§ãã‚‹ãƒšãƒ¼ã‚¹â€ã‚’å¤§äº‹ã«ã—ã¦ã­ã€‚`);
  } else {
    lines.push(`æ‹æ„›ã¯ã€Œä¼šè©±ã®æ°—æŒã¡ã‚ˆã•ã€ãŒéµã€‚ç„¡ç†ã—ãªãã¦ã„ã„ç›¸æ‰‹ãŒå½“ãŸã‚Šã€‚`);
  }
  lines.push("");

  lines.push(`## å¥åº·`);
  if (ctx.toneKey === "spicy"){
    lines.push(`å¥åº·ã€‚å¯ãªã„ã‚„ã¤ã‹ã‚‰å´©ã‚Œã‚‹ã€‚ãƒã‚¸ã§ã€‚`);
    lines.push(`å›å¾©ã§ããªã„äººã¯ã€çµå±€å…¨éƒ¨æ­¢ã¾ã‚‹ã€‚ä»Šæ—¥ã¯å¯ã‚ã€‚ã¡ã‚ƒã‚“ã¨ã€‚`);
  } else if (ctx.toneKey === "soft"){
    lines.push(`å¥åº·ã¯ã­ã€ãŒã‚“ã°ã‚Šã™ãã‚‹ã¨ä¸€æ°—ã«è½ã¡ã‚‹ã‹ã‚‰ã€ã“ã“å¤§äº‹ã€‚`);
    lines.push(`${speak(ctx.toneKey, "warn", "ä»Šæ—¥ã¯â€œå›å¾©â€ã‚’å„ªå…ˆã—ã¦ã­ã€‚")}`);
  } else {
    lines.push(`å¥åº·ã¯ã€Œç¡çœ ã¨é£Ÿäº‹ã€ãŒãƒ™ãƒ¼ã‚¹ã€‚ä»Šæ—¥ã¯å›å¾©ã«å¯„ã›ã‚‹ã¨é‹ã‚‚å®‰å®šã™ã‚‹ã€‚`);
  }
  lines.push("");

  lines.push(t.header);
  lines.push(t.closer);

  return lines.join("\n");
}

/* è£ãƒ¡ãƒ¢ï¼ˆå°‚é–€ç”¨èªã‚ã‚Šï¼‰ */
function makeDevText(ctx){
  const lines = [];
  lines.push(`Kuma Fortune / Version 1.2`);
  lines.push(`---`);
  lines.push(`[å…¥åŠ›]`);
  lines.push(`name=${ctx.name || ""}`);
  lines.push(`dob=${ctx.dobStr}`);
  lines.push(`place=${ctx.place}`);
  lines.push(`time=${ctx.timeLabel}`);
  lines.push(`tone=${ctx.toneKey}`);
  lines.push(``);
  lines.push(`[è¨ˆç®—ï¼ˆå°‚é–€ç”¨èªã‚ã‚Šï¼‰]`);
  lines.push(`Sun sign=${ctx.sunSign}`);
  lines.push(`Moon sign=${ctx.moonSignInfo}`);
  lines.push(`Mercury sign=${ctx.mercurySign}`);
  lines.push(`Venus sign=${ctx.venusSign}`);
  lines.push(`Mars sign=${ctx.marsSign}`);
  lines.push(`LifePath=${ctx.lp}`);
  lines.push(`typeKey=${ctx.typeKey}`);
  lines.push(``);
  lines.push(`[ä¸»è¦ã‚¢ã‚¹ãƒšã‚¯ãƒˆï¼ˆç°¡æ˜“ï¼‰]`);
  const aspPairs = [
    ["Sun","Moon","sun","moon"],
    ["Sun","Mars","sun","mars"],
    ["Mercury","Mars","mercury","mars"],
    ["Venus","Mars","venus","mars"],
    ["Sun","Venus","sun","venus"],
  ];
  for (const [A,B,ka,kb] of aspPairs){
    const a = ctx.lons[ka], b = ctx.lons[kb];
    const asp = aspectBetween(a,b);
    if (asp) lines.push(`${A} x ${B}: ${asp}`);
  }
  lines.push(``);
  lines.push(`[ãƒˆãƒ©ãƒ³ã‚¸ãƒƒãƒˆï¼ˆä»Šæ—¥ï¼‰]`);
  lines.push(`Today Sun=${ctx.todaySigns.sun}`);
  lines.push(`Today Moon=${ctx.todaySigns.moon}`);
  lines.push(`Today Mars=${ctx.todaySigns.mars}`);
  return lines.join("\n");
}

export function buildTexts(ctx){
  const type = TEXT_DB.types20[ctx.typeKey] ?? { name:"ãªãã®ã‚¯ãƒ", desc:"ã‚¿ã‚¤ãƒ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã€‚", tags:"-" };
  return {
    type,
    publicText: makePublicText(ctx),
    devText: makeDevText(ctx)
  };
}
